name: Backend CI

on:
    push:
        paths:
            - "apps/api/**"
            - ".eslintrc.js"
            - "package.json"
            - "pnpm-lock.yaml"
            - "tsconfig.json"
    pull_request:
        paths:
            - "apps/api/**"
            - ".eslintrc.js"
            - "package.json"
            - "pnpm-lock.yaml"
            - "tsconfig.json"

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        env:
            DB_URI: ${{ secrets.DB_URI }}
            AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
            AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
            AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
        defaults:
            run:
                working-directory: ./apps/api
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run lint
              run: pnpm run lint

            - name: Run tests
              run: pnpm run test -- --ci --reporter=spec

            - name: Cache pnpm store
              uses: actions/cache@v3
              with:
                  path: ~/.pnpm-store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-
